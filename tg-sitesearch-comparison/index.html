<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Site Search Comparison – Staging vs Production</title>
  <!-- Tailwind CSS via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- PapaParse for CSV parsing -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script>
    // Tailwind config (optional fine‑tuning for dark palette)
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            base: {
              900: '#0b0b0e', // page background
              800: '#111218', // section background
              700: '#1a1c23', // cards / columns
            }
          },
          fontFamily: {
            ui: ["Inter", "system-ui", "-apple-system", "Segoe UI", "Roboto", "Ubuntu", "Cantarell", "Noto Sans", "Helvetica Neue", "Arial", "sans-serif"],
          },
          boxShadow: {
            soft: '0 1px 0 rgba(255,255,255,0.03) inset, 0 8px 24px rgba(0,0,0,0.4)'
          }
        }
      }
    }
  </script>
  <style>
    /* Improves text rendering on dark backgrounds */
    html { color-scheme: dark; }
    
    /* Scrollable title behavior */
    .scrollable-title {
      overflow-x: hidden;
      white-space: nowrap;
      cursor: text;
      user-select: text;
      display: block;
      width: 100%;
    }
    
    .scrollable-title:hover,
    .scrollable-title:focus {
      overflow-x: auto;
    }
    
    /* Hide scrollbar but keep functionality */
    .scrollable-title::-webkit-scrollbar {
      height: 0;
    }
    
    .scrollable-title {
      scrollbar-width: none; /* Firefox */
    }
    
    /* Cross-reference highlighting */
    .cross-reference-highlight {
      background-color: rgba(34, 197, 94, 0.15) !important; /* muted green */
      border-color: rgba(34, 197, 94, 0.3) !important;
    }
    
    /* Presence indicator */
    .presence-indicator {
      width: 6px;
      height: 6px;
      background-color: rgba(34, 197, 94, 0.8);
      border-radius: 50%;
      flex-shrink: 0;
      margin-right: 8px;
    }
  </style>
</head>
<body class="bg-base-900 text-zinc-200 font-ui antialiased">
  <!-- Header -->
  <header class="sticky top-0 z-10 backdrop-blur supports-[backdrop-filter]:bg-base-900/70 bg-base-900/90 border-b border-zinc-800">
    <div class="mx-auto max-w-7xl px-4 py-4 flex items-center justify-between">
      <h1 class="text-lg md:text-2xl font-semibold tracking-tight">Site Search Comparison</h1>
      <div class="text-xs md:text-sm text-zinc-400">
        <div>Staging vs Production</div>
        <div id="snapshot-indicator" class="text-zinc-500"></div>
      </div>
    </div>
  </header>

  <main class="mx-auto max-w-7xl px-4 py-8 space-y-8">
    <!-- Note / legend -->
    <section class="rounded-2xl bg-base-800/80 ring-1 ring-zinc-800 p-4 md:p-6 shadow-soft">
      <p class="text-sm text-zinc-400">This page lists search results side‑by‑side for each query. Items in the <span class="font-medium text-zinc-200">Production</span> column that do not appear in <span class="font-medium text-zinc-200">Staging</span> for the same query are marked with a <span class="inline-flex items-center gap-1 rounded-md border border-amber-400/30 bg-amber-500/15 px-2 py-0.5 text-[11px] font-medium text-amber-300">Prod only</span> badge.</p>
    </section>

    <!-- Sections mount here -->
    <div id="sections" class="space-y-8"></div>
  </main>

  <!-- ===== Dynamic CSV Loading Script ===== -->
  <script>
    // Configuration
    const DEFAULT_TIMESTAMP = '20251016-173251';
    
    // Utility functions
    function $(sel, parent=document){ return parent.querySelector(sel); }
    function el(tag, cls, text){
      const n = document.createElement(tag);
      if (cls) n.className = cls;
      if (text != null) n.textContent = text;
      return n;
    }

    function normalizeSku(s){ return String(s || '').trim().toLowerCase(); }

    // Get timestamp from URL parameter or use default
    function getTimestamp() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('ts') || DEFAULT_TIMESTAMP;
    }

    // Load and parse CSV file
    function loadCSV(filename, hasHeader = true) {
      return new Promise((resolve, reject) => {
        Papa.parse(filename, {
          download: true,
          header: hasHeader,
          skipEmptyLines: true,
          delimiter: hasHeader ? "," : "", // Explicit delimiter for header files, auto-detect for simple lists
          complete: function(results) {
            if (results.errors.length > 0) {
              // Only reject if there are serious errors, not just delimiter warnings
              const seriousErrors = results.errors.filter(e => !e.message.includes('delimiting character'));
              if (seriousErrors.length > 0) {
                reject(new Error(`CSV parsing errors: ${seriousErrors.map(e => e.message).join(', ')}`));
              } else {
                resolve(results.data);
              }
            } else {
              resolve(results.data);
            }
          },
          error: function(error) {
            reject(error);
          }
        });
      });
    }

    // Group CSV data by query and sort by rank
    function groupByQuery(csvData) {
      const grouped = {};
      
      csvData.forEach(row => {
        const query = row.query?.trim();
        if (!query) return;
        
        if (!grouped[query]) {
          grouped[query] = [];
        }
        
        grouped[query].push({
          sku: row.sku?.trim(),
          title: row.name?.trim() || row.sku?.trim() || 'Untitled',
          rank: parseInt(row.rank) || 999,
          total_count: parseInt(row.total_count) || 0
        });
      });
      
      // Sort each query's results by rank
      Object.keys(grouped).forEach(query => {
        grouped[query].sort((a, b) => a.rank - b.rank);
      });
      
      return grouped;
    }

    // Main rendering function
    async function render() {
      const timestamp = getTimestamp();
      const snapshotIndicator = $('#snapshot-indicator');
      const mount = $('#sections');
      
      try {
        // Update snapshot indicator
        snapshotIndicator.textContent = `Snapshot: ${timestamp}`;
        
        // Show loading state
        mount.innerHTML = '<div class="text-center py-8 text-zinc-400">Loading CSV data...</div>';
        
        // Load all three CSV files
        const [stagingData, prodData, prodOnlySkus] = await Promise.all([
          loadCSV(`stage_snapshot_${timestamp}.csv`),
          loadCSV(`prod_snapshot_${timestamp}.csv`),
          loadCSV('prod_only_skus.csv', false) // No header for simple SKU list
        ]);
        
        // Create Set of prod-only SKUs for fast lookup
        const prodOnlySkuSet = new Set(
          prodOnlySkus.map(row => normalizeSku(row[0])).filter(sku => sku) // First column is SKU, filter out empty strings
        );
        
        // Group data by query
        const stagingGrouped = groupByQuery(stagingData);
        const prodGrouped = groupByQuery(prodData);
        
        // Get all unique queries
        const allQueries = new Set([
          ...Object.keys(stagingGrouped),
          ...Object.keys(prodGrouped)
        ]);
        
        // Clear loading state
        mount.innerHTML = '';
        
        // Render each query
        Array.from(allQueries).sort().forEach(query => {
          const stagingItems = stagingGrouped[query] || [];
          const prodItems = prodGrouped[query] || [];
          
          // Create sets for cross-reference matching
          const stagingSkus = new Set(stagingItems.map(item => normalizeSku(item.sku)));
          const prodSkus = new Set(prodItems.map(item => normalizeSku(item.sku)));
          
          // Section wrapper
          const section = el('section', 'rounded-2xl bg-base-800/80 ring-1 ring-zinc-800 shadow-soft');
          
          // Header bar
          const header = el('div', 'flex items-center justify-between px-4 md:px-6 py-3 border-b border-zinc-800');
          const title = el('h2', 'text-base md:text-lg font-semibold tracking-tight', query);
          const count = el('div', 'text-xs text-zinc-400');
          count.textContent = `Staging: ${stagingItems.length} • Production: ${prodItems.length}`;
          header.append(title, count);
          
          // Columns
          const grid = el('div', 'grid grid-cols-1 md:grid-cols-2 gap-0');
          
          const stagingCol = column('Staging', stagingItems, { 
            emphasize: false, 
            prodOnlySkus: prodOnlySkuSet,
            crossReferenceSkus: prodSkus,
            oppositeColumnSkus: prodSkus
          });
          const productionCol = column('Production', prodItems, { 
            emphasize: true, 
            prodOnlySkus: prodOnlySkuSet,
            crossReferenceSkus: stagingSkus,
            oppositeColumnSkus: stagingSkus
          });
          
          grid.append(stagingCol, productionCol);
          
          section.append(header, grid);
          mount.append(section);
        });
        
      } catch (error) {
        console.error('Error loading CSV data:', error);
        mount.innerHTML = `
          <div class="rounded-2xl bg-red-900/20 ring-1 ring-red-800 p-6 text-center">
            <h3 class="text-lg font-semibold text-red-300 mb-2">Error Loading Data</h3>
            <p class="text-sm text-red-200 mb-4">Failed to load CSV files for timestamp: ${timestamp}</p>
            <p class="text-xs text-red-300">${error.message}</p>
            <p class="text-xs text-zinc-400 mt-2">Make sure the CSV files exist and the timestamp parameter is correct.</p>
          </div>
        `;
        snapshotIndicator.textContent = `Error: ${timestamp}`;
      }
    }

    function column(title, items, opts={}) {
      const wrap = el('div', 'p-4 md:p-6');
      const head = el('div', 'mb-3 flex items-center justify-between');
      head.append(
        el('h3', 'text-sm font-medium uppercase tracking-wide text-zinc-400', title)
      );

      const list = el('ol', 'space-y-2');

      (items || []).forEach((item, i) => {
        const row = el('li', 'rounded-xl bg-base-700/70 ring-1 ring-zinc-800 px-3 py-2');
        row.setAttribute('data-sku', normalizeSku(item.sku)); // Add data attribute for easier matching
        const top = el('div', 'flex items-start justify-between gap-3');
        
        // Left side with presence indicator, number and content
        const left = el('div', 'flex items-start gap-2 min-w-0 flex-1');
        
        // Presence indicator (green dot for items in both environments)
        const hasPresenceIndicator = opts.oppositeColumnSkus && item.sku && opts.oppositeColumnSkus.has(normalizeSku(item.sku));
        if (hasPresenceIndicator) {
          const presenceDot = el('div', 'presence-indicator');
          left.append(presenceDot);
        }
        
        const rank = el('span', 'shrink-0 text-zinc-500', String(item.rank || i+1)+'.');
        const content = el('div', 'min-w-0 flex-1 overflow-hidden');
        
        const titleEl = el('span', 'text-sm font-medium text-zinc-200 scrollable-title', item.title || item.sku || 'Untitled');
        const meta = el('div', 'mt-0.5 text-[11px] text-zinc-400 break-words');
        meta.textContent = item.sku ? String(item.sku) : '';
        
        content.append(titleEl, meta);
        left.append(rank, content);

        // Badge for Prod‑only (only when opts.emphasize === true and sku is in prod-only set)
        if (opts.emphasize && opts.prodOnlySkus && item.sku && opts.prodOnlySkus.has(normalizeSku(item.sku))) {
          const badge = el('span', 'ml-2 inline-flex items-center gap-1 rounded-md border border-amber-400/30 bg-amber-500/15 px-2 py-0.5 text-[11px] font-medium text-amber-300');
          badge.textContent = 'Prod only';
          top.append(badge);
        }

        // Add hover event for cross-reference highlighting
        if (opts.crossReferenceSkus && item.sku && opts.crossReferenceSkus.has(normalizeSku(item.sku))) {
          row.addEventListener('mouseenter', function() {
            // Find and highlight matching items in both columns
            const section = row.closest('section');
            const currentSku = row.getAttribute('data-sku');
            const allRows = section.querySelectorAll('li');
            allRows.forEach(otherRow => {
              if (otherRow.getAttribute('data-sku') === currentSku) {
                otherRow.classList.add('cross-reference-highlight');
              }
            });
          });
          
          row.addEventListener('mouseleave', function() {
            // Remove highlighting from all rows
            const section = row.closest('section');
            const allRows = section.querySelectorAll('li');
            allRows.forEach(otherRow => {
              otherRow.classList.remove('cross-reference-highlight');
            });
          });
        }

        top.prepend(left);
        row.append(top);
        list.append(row);
      });

      wrap.append(head, list);
      return wrap;
    }

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', render);
  </script>
</body>
</html>
